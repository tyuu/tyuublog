<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Chapter 9 - 编解码器过滤器 | Apache MINA User Guide 中文翻译《Apache MINA 2 用户指南》 </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../Part II - MINA Core/Chapter 10 - Executor Filter.html" />
    
    
    <link rel="prev" href="../Part II - MINA Core/Chapter 8 - IoBuffer.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.2"
        data-chapter-title="Chapter 9 - 编解码器过滤器"
        data-filepath="Part II - MINA Core/Chapter 9 - Codec Filter.md"
        data-basepath=".."
        data-revision="Sat Apr 09 2016 12:59:17 GMT+0800 (CST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> Part I - Basics 基础</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="Part I - Basics/Chapter 1 - Getting Started.html">
            
                
                    <a href="../Part I - Basics/Chapter 1 - Getting Started.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Chapter 1 - 开始
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="Part I - Basics/NIO Overview.html">
            
                
                    <a href="../Part I - Basics/NIO Overview.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.1.</b>
                        
                        NIO 总览
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="Part I - Basics/Why MINA.html">
            
                
                    <a href="../Part I - Basics/Why MINA.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.2.</b>
                        
                        为何使用 MINA
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="Part I - Basics/Features.html">
            
                
                    <a href="../Part I - Basics/Features.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.3.</b>
                        
                        特性
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="Part I - Basics/First steps.html">
            
                
                    <a href="../Part I - Basics/First steps.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.4.</b>
                        
                        开始的步骤
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="Part I - Basics/c1 Summary.html">
            
                
                    <a href="../Part I - Basics/c1 Summary.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.5.</b>
                        
                        总结
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.1" data-path="Part I - Basics/Chapter 2 - Basics.html">
            
                
                    <a href="../Part I - Basics/Chapter 2 - Basics.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.5.1.</b>
                        
                        Chapter 2 - 基础
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="Part I - Basics/Application Architecture.html">
            
                
                    <a href="../Part I - Basics/Application Architecture.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.6.</b>
                        
                        应用架构
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.6.1" data-path="Part I - Basics/Server Architecture.html">
            
                
                    <a href="../Part I - Basics/Server Architecture.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.6.1.</b>
                        
                        服务端架构
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.6.2" data-path="Part I - Basics/Client Architecture.html">
            
                
                    <a href="../Part I - Basics/Client Architecture.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.6.2.</b>
                        
                        客户端架构
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="Part I - Basics/Sample TCP Server.html">
            
                
                    <a href="../Part I - Basics/Sample TCP Server.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.7.</b>
                        
                        TCP Server 示例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="Part I - Basics/Sample TCP Client.html">
            
                
                    <a href="../Part I - Basics/Sample TCP Client.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.8.</b>
                        
                        TCP Client 示例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.9" data-path="Part I - Basics/Sample UDP Server.html">
            
                
                    <a href="../Part I - Basics/Sample UDP Server.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.9.</b>
                        
                        UDP Server 示例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.10" data-path="Part I - Basics/Sample UDP Client.html">
            
                
                    <a href="../Part I - Basics/Sample UDP Client.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.10.</b>
                        
                        UDP Client 示例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.11" data-path="Part I - Basics/c2 Summary.html">
            
                
                    <a href="../Part I - Basics/c2 Summary.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.11.</b>
                        
                        总结
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.11.1" data-path="Part I - Basics/Chapter 3 - Service.html">
            
                
                    <a href="../Part I - Basics/Chapter 3 - Service.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.11.1.</b>
                        
                        Chapter 3 - 服务
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.12" data-path="Part I - Basics/IoService Introduction.html">
            
            <span><b>1.1.12.</b> IoService 介绍</span>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.13" data-path="Part I - Basics/IoService Details.html">
            
                
                    <a href="../Part I - Basics/IoService Details.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.13.</b>
                        
                        IoService 细节
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.14" data-path="Part I - Basics/Acceptor.html">
            
                
                    <a href="../Part I - Basics/Acceptor.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.14.</b>
                        
                        Acceptor
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.15" data-path="Part I - Basics/Connector.html">
            
                
                    <a href="../Part I - Basics/Connector.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.15.</b>
                        
                        Connector
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.15.1" data-path="Part I - Basics/Chapter 4 - Session.html">
            
                
                    <a href="../Part I - Basics/Chapter 4 - Session.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.15.1.</b>
                        
                        Chapter 4 - Session(会话)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.15.2" data-path="Part I - Basics/Chapter 5 - Filters.html">
            
                
                    <a href="../Part I - Basics/Chapter 5 - Filters.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.15.2.</b>
                        
                        Chapter 5 - Filter (过滤器)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.15.3" data-path="Part I - Basics/Chapter 6 - Transports.html">
            
                
                    <a href="../Part I - Basics/Chapter 6 - Transports.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.15.3.</b>
                        
                        Chapter 6 - Transport (传输)
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.16" data-path="Part I - Basics/APR Transport.html">
            
                
                    <a href="../Part I - Basics/APR Transport.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.16.</b>
                        
                        APR 传输
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.17" data-path="Part I - Basics/Serial Transport.html">
            
                
                    <a href="../Part I - Basics/Serial Transport.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.17.</b>
                        
                        串行传输
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.17.1" data-path="Part I - Basics/Chapter 7 - Handler.html">
            
                
                    <a href="../Part I - Basics/Chapter 7 - Handler.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.17.1.</b>
                        
                        Chapter 7 - Handler (处理器)
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Part II - MINA Core 核心</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="Part II - MINA Core/Chapter 8 - IoBuffer.html">
            
                
                    <a href="../Part II - MINA Core/Chapter 8 - IoBuffer.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Chapter 8 - IoBuffer
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.2" data-path="Part II - MINA Core/Chapter 9 - Codec Filter.html">
            
                
                    <a href="../Part II - MINA Core/Chapter 9 - Codec Filter.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Chapter 9 - 编解码器过滤器
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="Part II - MINA Core/Chapter 10 - Executor Filter.html">
            
                
                    <a href="../Part II - MINA Core/Chapter 10 - Executor Filter.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Chapter 10 - Executor 过滤器
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="Part II - MINA Core/Chapter 11 - SSL Filter.html">
            
                
                    <a href="../Part II - MINA Core/Chapter 11 - SSL Filter.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Chapter 11 - SSL 过滤器
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="Part II - MINA Core/Chapter 12 - Logging Filter.html">
            
                
                    <a href="../Part II - MINA Core/Chapter 12 - Logging Filter.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Chapter 12 - 日志过滤器
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Part III - MINA Advanced 高级</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="Part III - MINA Advanced/Chapter 13 - Debugging.html">
            
                
                    <a href="../Part III - MINA Advanced/Chapter 13 - Debugging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Chapter 13 - 调试
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="Part III - MINA Advanced/Chapter 14 - State Machine.html">
            
                
                    <a href="../Part III - MINA Advanced/Chapter 14 - State Machine.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Chapter 14 - State Machine (状态机)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="Part III - MINA Advanced/Chapter 15 - Proxy.html">
            
                
                    <a href="../Part III - MINA Advanced/Chapter 15 - Proxy.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Chapter 15 - 代理
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="Part III - MINA Advanced/Chapter 16 - JMX Integration.html">
            
                
                    <a href="../Part III - MINA Advanced/Chapter 16 - JMX Integration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Chapter 16 - JMX 集成
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="Part III - MINA Advanced/Chapter 17 - Spring Integration.html">
            
                
                    <a href="../Part III - MINA Advanced/Chapter 17 - Spring Integration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        Chapter 17 - Spring 集成
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" >
            
            <span><b>4.</b> 其他</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" >
            
                
                    <a target="_blank" href="http:/www.waylau.com/mina-quick-start/">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        MINA 快速入门
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                
                    <a target="_blank" href="http:/www.waylau.com/mina-chat/">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        MINA 实现聊天功能
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Apache MINA User Guide 中文翻译《Apache MINA 2 用户指南》 </a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="&#x7F16;&#x89E3;&#x7801;&#x5668;&#x8FC7;&#x6EE4;&#x5668;">&#x7F16;&#x89E3;&#x7801;&#x5668;&#x8FC7;&#x6EE4;&#x5668;</h1>
<p>&#x672C;&#x6587;&#x89E3;&#x91CA;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;&#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x4E00;&#x4E2A; ProtocolCodecFilter&#x3002;</p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528;-protocolcodecfilter&#xFF1F;">&#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528; ProtocolCodecFilter&#xFF1F;</h2>
<ul>
<li>TCP &#x62C5;&#x4FDD;&#x4EE5;&#x6B63;&#x786E;&#x7684;&#x987A;&#x5E8F;&#x4EA4;&#x4ED8;&#x6240;&#x6709;&#x6570;&#x636E;&#x5305;&#x3002;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x62C5;&#x4FDD;&#x5BF9;&#x4E8E;&#x5728;&#x53D1;&#x9001;&#x7AEF;&#x5199;&#x64CD;&#x4F5C;&#x65F6;&#x5F71;&#x54CD;&#x5230;&#x63A5;&#x6536;&#x7AEF;&#x7684;&#x8BFB;&#x4E8B;&#x4EF6;&#x3002;&#x53C2;&#x8003; <a href="http://en.wikipedia.org/wiki/IPv4#Fragmentation_and_reassembly" target="_blank">http://en.wikipedia.org/wiki/IPv4#Fragmentation_and_reassembly</a> &#x548C; <a href="http://en.wikipedia.org/wiki/Nagle%27s_algorithm" target="_blank">http://en.wikipedia.org/wiki/Nagle%27s_algorithm</a>&#x3002;&#x5728; MINA &#x672F;&#x8BED;&#x4E2D;&#xFF1A;&#x5982;&#x679C;&#x6CA1;&#x6709; ProtocolCodecFilter &#x7684;&#x8BDD;&#xFF0C;&#x4E00;&#x4E2A;&#x7531;&#x53D1;&#x9001;&#x7AEF;&#x5BF9; IoSession.write(Object message) &#x7684;&#x8C03;&#x7528;&#x5C06;&#x5BFC;&#x81F4;&#x591A;&#x4E2A;&#x63A5;&#x6536;&#x7AEF;&#x7684; messageReceived(IoSession session, Object message) &#x4E8B;&#x4EF6;&#xFF0C;&#x800C;&#x591A;&#x4E2A; IoSession.write(Object message) &#x7684;&#x8C03;&#x7528;&#x53EA;&#x4F1A;&#x5F15;&#x8D77;&#x552F;&#x4E00;&#x7684;&#x4E00;&#x4E2A; messageReceived &#x4E8B;&#x4EF6;&#x3002;&#x5F53;&#x4F60;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x8FD0;&#x884C;&#x5728;&#x540C;&#x4E00;&#x53F0;&#x4E3B;&#x673A;&#x4E0A; (&#x6216;&#x8005;&#x5904;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x672C;&#x5730;&#x7F51;) &#x800C;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x80FD;&#x591F;&#x5E94;&#x5BF9;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x65F6;&#xFF0C;&#x4F60;&#x53EF;&#x80FD;&#x4E0D;&#x4F1A;&#x906D;&#x9047;&#x5230;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x3002;</li>
<li>&#x5927;&#x591A;&#x6570;&#x7F51;&#x7EDC;&#x5E94;&#x7528;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x4EE5;&#x627E;&#x51FA;&#x5F53;&#x524D;&#x6D88;&#x606F;&#x7684;&#x7ED3;&#x675F;&#x4F4D;&#x7F6E;&#x548C;&#x4E0B;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x4F60;&#x5B8C;&#x5168;&#x53EF;&#x4EE5;&#x5728;&#x4F60;&#x7684; IoHandler &#x5B9E;&#x73B0;&#x6240;&#x6709;&#x7684;&#x8FD9;&#x4E9B;&#x903B;&#x8F91;&#xFF0C;&#x4F46;&#x662F;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; ProtocolCodecFilter &#x53EF;&#x4EE5;&#x8BA9;&#x4F60;&#x7684;&#x4EE3;&#x7801;&#x66F4;&#x52A0;&#x6E05;&#x6670;&#x5E76;&#x5BB9;&#x6613;&#x7EF4;&#x62A4;&#x3002;</li>
<li>&#x5B83;&#x5C06;&#x4F60;&#x7684;&#x534F;&#x8BAE;&#x903B;&#x8F91;&#x4ECE;&#x4F60;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x4E2D; (IoHandler) &#x5265;&#x79BB;&#x5F00;&#x6765;&#x3002;</li>
</ul>
<h2 id="&#x5982;&#x4F55;&#x4F7F;&#x7528;&#xFF1F;">&#x5982;&#x4F55;&#x4F7F;&#x7528;&#xFF1F;</h2>
<p>&#x4F60;&#x7684;&#x5E94;&#x7528;&#x63A5;&#x6536;&#x5230;&#x7684;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x4E00;&#x4E32;&#x5B57;&#x8282;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x8FD9;&#x4E9B;&#x5B57;&#x8282;&#x8F6C;&#x6362;&#x4E3A;&#x6D88;&#x606F; (&#x9AD8;&#x5C42;&#x5BF9;&#x8C61;)&#x3002;</p>
<p>&#x6709;&#x4E09;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x6280;&#x672F;&#x7528;&#x6765;&#x5C06;&#x5B57;&#x8282;&#x6D41;&#x5206;&#x5272;&#x4E3A;&#x6D88;&#x606F;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x5B57;&#x8282;</li>
<li>&#x4F7F;&#x7528;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x62A5;&#x5934;&#x6765;&#x6307;&#x793A;&#x51FA;&#x62A5;&#x4F53;&#x7684;&#x957F;&#x5EA6;</li>
<li>&#x4F7F;&#x7528;&#x5B9A;&#x754C;&#x7B26;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x8BB8;&#x591A;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x5728;&#x6BCF;&#x6761;&#x6D88;&#x606F; (<a href="http://www.faqs.org/rfcs/rfc977.html" target="_blank">http://www.faqs.org/rfcs/rfc977.html</a>) &#x540E;&#x9762;&#x7D27;&#x8DDF;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7A7A;&#x884C; (&#x6216;&#x8005; CR LF &#x5BF9;)&#x3002;</li>
</ul>
<p>&#x672C;&#x6587;&#x5C06;&#x4F7F;&#x7528;&#x7B2C;&#x4E00;&#x79CD;&#x548C;&#x7B2C;&#x4E8C;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x5F88;&#x660E;&#x663E;&#x66F4;&#x5BB9;&#x6613;&#x5B9E;&#x73B0;&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x4E00;&#x4E0B;&#x4F7F;&#x7528;&#x5B9A;&#x754C;&#x7B26;&#x7684;&#x505A;&#x6CD5;&#x3002;</p>
<h2 id="&#x4F8B;&#x5B50;">&#x4F8B;&#x5B50;</h2>
<p>&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x5F00;&#x53D1;&#x4E00;&#x4E2A; (&#x6BEB;&#x65E0;&#x7528;&#x5904;&#x7684;) &#x56FE;&#x5F62;&#x5B57;&#x7B26;&#x53D1;&#x751F;&#x5668;&#x534F;&#x8BAE;&#x670D;&#x52A1;&#x5668;&#x6765;&#x8BF4;&#x660E;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x4F60;&#x81EA;&#x5DF1;&#x534F;&#x8BAE;&#x7684;&#x7F16;&#x89E3;&#x7801;&#x5668; (ProtocolEncoder&#x3001;ProtocolDecoder &#x548C; ProtocolCodecFactory)&#x3002;&#x8FD9;&#x4E2A;&#x534F;&#x8BAE;&#x662F;&#x5F88;&#x7B80;&#x5355;&#x7684;&#x3002;&#x8FD9;&#x662F;&#x8BF7;&#x6C42;&#x6D88;&#x606F;&#x7684;&#x5E03;&#x5C40;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>4 bytes</th>
<th>4 bytes</th>
<th>4 bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td>width</td>
<td>height</td>
<td>numchars</td>
</tr>
</tbody>
</table>

<ul>
<li>width&#xFF1A;&#x88AB;&#x8BF7;&#x6C42;&#x56FE;&#x7247;&#x7684;&#x5BBD;&#x5EA6; (&#x7F51;&#x7EDC;&#x5B57;&#x8282;&#x987A;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x6574;&#x6570;)</li>
<li>height&#xFF1A;&#x88AB;&#x8BF7;&#x6C42;&#x56FE;&#x7247;&#x7684;&#x9AD8;&#x5EA6; (&#x7F51;&#x7EDC;&#x5B57;&#x8282;&#x987A;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x6574;&#x6570;)</li>
<li>numchars&#xFF1A;&#x8981;&#x751F;&#x6210;&#x7684;&#x5B57;&#x7B26;&#x6570; (&#x7F51;&#x7EDC;&#x5B57;&#x8282;&#x987A;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x6574;&#x6570;)</li>
</ul>
<p>&#x670D;&#x52A1;&#x5668;&#x4EE5;&#x7B26;&#x5408;&#x8BF7;&#x6C42;&#x5C3A;&#x5BF8;&#x7684;&#x4E24;&#x5F20;&#x56FE;&#x7247;&#x8FDB;&#x884C;&#x54CD;&#x5E94;&#xFF0C;&#x6BCF;&#x5F20;&#x56FE;&#x7247;&#x4E0A;&#x6253;&#x4E0A;&#x8BF7;&#x6C42;&#x7684;&#x5B57;&#x7B26;&#x6570;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x6D88;&#x606F;&#x7684;&#x5E03;&#x5C40;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>4 bytes</th>
<th>variable length body</th>
<th>4 bytes</th>
<th>variable length body</th>
</tr>
</thead>
<tbody>
<tr>
<td>length1</td>
<td>image1</td>
<td>length2</td>
<td>image2</td>
</tr>
</tbody>
</table>

<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x7528;&#x4E8E;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x7684;&#x7F16;&#x7801;&#x548C;&#x89E3;&#x7801;&#x7684;&#x7C7B;&#x7684;&#x6982;&#x8FF0;&#xFF1A;</p>
<ul>
<li>ImageRequest&#xFF1A;&#x4E00;&#x4E2A;&#x8868;&#x793A;&#x5BF9;&#x6211;&#x4EEC;&#x7684;&#x56FE;&#x7247;&#x670D;&#x52A1;&#x5668;&#x8BF7;&#x6C42;&#x7684;&#x7B80;&#x5355;&#x7684; POJO</li>
<li>ImageRequestEncoder&#xFF1A;&#x5C06; ImageRequest &#x5BF9;&#x8C61;&#x7F16;&#x7801;&#x4E3A;&#x534F;&#x8BAE;&#x4E13;&#x7528;&#x6570;&#x636E; (&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;)</li>
<li>ImageRequestDecoder&#xFF1A;&#x5C06;&#x534F;&#x8BAE;&#x4E13;&#x7528;&#x6570;&#x636E;&#x89E3;&#x7801;&#x4E3A; ImageRequest &#x5BF9;&#x8C61; (&#x7531;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4F7F;&#x7528;)</li>
<li>ImageResponse&#xFF1A;&#x4E00;&#x4E2A;&#x8868;&#x793A;&#x6765;&#x81EA;&#x6211;&#x4EEC;&#x56FE;&#x7247;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x54CD;&#x5E94;&#x7684;&#x7B80;&#x5355;&#x7684; POJO</li>
<li>ImageResponseEncoder&#xFF1A;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7528;&#x4EE5;&#x5BF9; ImageResponse &#x5BF9;&#x8C61;&#x7F16;&#x7801;&#x7684;&#x7C7B;</li>
<li>ImageResponseDecoder&#xFF1A;&#x5BA2;&#x6237;&#x7AEF;&#x7528;&#x4EE5;&#x5BF9; ImageResponse &#x5BF9;&#x8C61;&#x89E3;&#x7801;&#x7684;&#x7C7B;</li>
<li>ImageCodecFactory&#xFF1A;&#x8FD9;&#x4E2A;&#x7C7B;&#x8D1F;&#x8D23;&#x521B;&#x5EFA;&#x9700;&#x8981;&#x7684;&#x7F16;&#x7801;&#x5668;&#x548C;&#x89E3;&#x7801;&#x5668;</li>
</ul>
<p>ImageRequest &#x7C7B;&#x6E90;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>public class ImageRequest {

    private int width;
    private int height;
    private int numberOfCharacters;

    public ImageRequest(int width, int height, int numberOfCharacters) {
        this.width = width;
        this.height = height;
        this.numberOfCharacters = numberOfCharacters;
    }

    public int getWidth() {
        return width;
    }

    public int getHeight() {
        return height;
    }

    public int getNumberOfCharacters() {
        return numberOfCharacters;
    }
}
</code></pre><p>&#x7F16;&#x7801;&#x5F80;&#x5F80;&#x6BD4;&#x89E3;&#x7801;&#x5BB9;&#x6613;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5148;&#x4ECE; ImageRequestEncoder &#x5F00;&#x59CB;&#xFF1A;</p>
<pre><code>public class ImageRequestEncoder implements ProtocolEncoder {

    public void encode(IoSession session, Object message, ProtocolEncoderOutput out) throws Exception {
        ImageRequest request = (ImageRequest) message;
        IoBuffer buffer = IoBuffer.allocate(12, false);
        buffer.putInt(request.getWidth());
        buffer.putInt(request.getHeight());
        buffer.putInt(request.getNumberOfCharacters());
        buffer.flip();
        out.write(buffer);
    }

    public void dispose(IoSession session) throws Exception {
        // nothing to dispose
    }
}
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;</p>
<ul>
<li>MINA &#x5C06;&#x4F1A;&#x4E3A;&#x6240;&#x6709;&#x5728; IoSession &#x7684;&#x5199;&#x961F;&#x5217;&#x91CC;&#x7684;&#x6D88;&#x606F;&#x8C03;&#x7528;&#x7F16;&#x7801;&#x65B9;&#x6CD5;&#x3002;&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x53EA;&#x4F1A;&#x5199; ImageRequest &#x5BF9;&#x8C61;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x5730;&#x628A;&#x6D88;&#x606F;&#x653E;&#x8FDB; ImageRequest</li>
<li>&#x6211;&#x4EEC;&#x5728;&#x5806;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; IoBuffer&#x3002;&#x6700;&#x597D;&#x907F;&#x514D;&#x4F7F;&#x7528;&#x76F4;&#x63A5;&#x7F13;&#x5B58;&#xFF0C;&#x56E0;&#x4E3A;&#x901A;&#x5E38;&#x5806;&#x7F13;&#x5B58;&#x8868;&#x73B0;&#x7684;&#x66F4;&#x597D;&#x3002;&#x53C2;&#x8003; <a href="http://issues.apache.org/jira/browse/DIRMINA-289" target="_blank">http://issues.apache.org/jira/browse/DIRMINA-289</a></li>
<li>&#x4E0D;&#x9700;&#x8981;&#x4F60;&#x53BB;&#x91CA;&#x653E;&#x7F13;&#x5B58;&#xFF0C;MINA &#x4E3A;&#x4F60;&#x4EE3;&#x52B3;&#x4E86;&#x3002;&#x53C2;&#x8003;<a href="http://mina.apache.org/mina-project/apidocs/org/apache/mina/core/buffer/IoBuffer.html" target="_blank">http://mina.apache.org/mina-project/apidocs/org/apache/mina/core/buffer/IoBuffer.html</a></li>
<li>&#x4F60;&#x5E94;&#x8BE5;&#x5728; dispose() &#x65B9;&#x6CD5;&#x4E2D;&#x91CA;&#x653E;&#x6240;&#x6709;&#x5728;&#x4E3A;&#x7279;&#x5B9A;&#x4F1A;&#x8BDD;&#x7F16;&#x7801;&#x65F6;&#x6240;&#x83B7;&#x53D6;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4E8B;&#x60C5;&#x8981;&#x5904;&#x7406;&#x4F60;&#x53EF;&#x4EE5;&#x8BA9;&#x4F60;&#x7684;&#x7F16;&#x7801;&#x5668;&#x7EE7;&#x627F;&#x81EA; ProtocolEncoderAdapter</li>
</ul>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x89E3;&#x7801;&#x5668;&#x3002;CumulativeProtocolDecoder &#x7EDD;&#x5BF9;&#x5BF9;&#x5199;&#x4F60;&#x81EA;&#x5DF1;&#x7684;&#x7F16;&#x7801;&#x5668;&#x6709;&#x5F88;&#x5927;&#x5E2E;&#x52A9;&#xFF1A;&#x5B83;&#x5C06;&#x628A;&#x4F60;&#x7684;&#x89E3;&#x7801;&#x5668;&#x51B3;&#x5B9A;&#x5BF9;&#x8FDE;&#x5165;&#x6570;&#x636E;&#x53EF;&#x4EE5;&#x505A;&#x4E00;&#x4E9B;&#x4E8B;&#x60C5;&#x4E4B;&#x524D;&#x90FD;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#x3002;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x6D88;&#x606F;&#x5177;&#x6709;&#x56FA;&#x5B9A;&#x5927;&#x5C0F;&#xFF0C;&#x56E0;&#x6B64;&#x5F88;&#x5BB9;&#x6613;&#x7B49;&#x5F85;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#x5230;&#x9F50;&#x4EE5;&#x540E;&#x518D;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<pre><code>public class ImageRequestDecoder extends CumulativeProtocolDecoder {

    protected boolean doDecode(IoSession session, IoBuffer in, ProtocolDecoderOutput out) throws Exception {
        if (in.remaining() &gt;= 12) {
            int width = in.getInt();
            int height = in.getInt();
            int numberOfCharachters = in.getInt();
            ImageRequest request = new ImageRequest(width, height, numberOfCharachters);
            out.write(request);
            return true;
        } else {
            return false;
        }
    }
}
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;</p>
<ul>
<li>&#x6BCF;&#x6B21;&#x5728;&#x5BF9;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D88;&#x606F;&#x7F16;&#x7801;&#x65F6;&#xFF0C;&#x4F60;&#x5E94;&#x8BE5;&#x5C06;&#x5176;&#x5199;&#x8FDB;
ProtocolDecoderOutput&#xFF1B;&#x8FD9;&#x4E9B;&#x6D88;&#x606F;&#x5C06;&#x7A7F;&#x8FC7;&#x8FC7;&#x6EE4;&#x5668;&#x94FE;&#x5E76;&#x6700;&#x7EC8;&#x5230;&#x8FBE;&#x4F60;&#x7684; IoHandler.messageReceived &#x65B9;&#x6CD5;</li>
<li>&#x4F60;&#x4E0D;&#x5FC5;&#x8D1F;&#x8D23;&#x91CA;&#x653E; IoBuffer</li>
<li>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8DB3;&#x591F;&#x7684;&#x53EF;&#x7528;&#x6570;&#x636E;&#x7528;&#x4EE5;&#x89E3;&#x7801;&#x4E00;&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x53EA;&#x9700;&#x8FD4;&#x56DE; false</li>
</ul>
<p>&#x54CD;&#x5E94;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684; POJO&#xFF1A;</p>
<pre><code>public class ImageResponse {

    private BufferedImage image1;

    private BufferedImage image2;

    public ImageResponse(BufferedImage image1, BufferedImage image2) {
        this.image1 = image1;
        this.image2 = image2;
    }

    public BufferedImage getImage1() {
        return image1;
    }

    public BufferedImage getImage2() {
        return image2;
    }
}
</code></pre><p>&#x54CD;&#x5E94;&#x7684;&#x7F16;&#x7801;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF1A;</p>
<pre><code>public class ImageResponseEncoder extends ProtocolEncoderAdapter {

    public void encode(IoSession session, Object message, ProtocolEncoderOutput out) throws Exception {
        ImageResponse imageResponse = (ImageResponse) message;
        byte[] bytes1 = getBytes(imageResponse.getImage1());
        byte[] bytes2 = getBytes(imageResponse.getImage2());
        int capacity = bytes1.length + bytes2.length + 8;
        IoBuffer buffer = IoBuffer.allocate(capacity, false);
        buffer.setAutoExpand(true);
        buffer.putInt(bytes1.length);
        buffer.put(bytes1);
        buffer.putInt(bytes2.length);
        buffer.put(bytes2);
        buffer.flip();
        out.write(buffer);
    }

    private byte[] getBytes(BufferedImage image) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ImageIO.write(image, &quot;PNG&quot;, baos);
        return baos.toByteArray();
    }
}
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;</p>
<p>&#x5F53;&#x65E0;&#x6CD5;&#x63D0;&#x524D;&#x9884;&#x6D4B; IoBuffer &#x7684;&#x957F;&#x5EA6;&#x65F6;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x7528; buffer.setAutoExpand(true); &#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x81EA;&#x52A8;&#x6269;&#x5C55;&#x7F13;&#x5B58;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x54CD;&#x5E94;&#x7684;&#x89E3;&#x7801;&#xFF1A;</p>
<pre><code>public class ImageResponseDecoder extends CumulativeProtocolDecoder {

    private static final String DECODER_STATE_KEY = ImageResponseDecoder.class.getName() + &quot;.STATE&quot;;

    public static final int MAX_IMAGE_SIZE = 5 * 1024 * 1024;

    private static class DecoderState {
        BufferedImage image1;
    }

    protected boolean doDecode(IoSession session, IoBuffer in, ProtocolDecoderOutput out) throws Exception {
        DecoderState decoderState = (DecoderState) session.getAttribute(DECODER_STATE_KEY);
        if (decoderState == null) {
            decoderState = new DecoderState();
            session.setAttribute(DECODER_STATE_KEY, decoderState);
        }
        if (decoderState.image1 == null) {
            // try to read first image
            if (in.prefixedDataAvailable(4, MAX_IMAGE_SIZE)) {
                decoderState.image1 = readImage(in);
            } else {
                // not enough data available to read first image
                return false;
            }
        }
        if (decoderState.image1 != null) {
            // try to read second image
            if (in.prefixedDataAvailable(4, MAX_IMAGE_SIZE)) {
                BufferedImage image2 = readImage(in);
                ImageResponse imageResponse = new ImageResponse(decoderState.image1, image2);
                out.write(imageResponse);
                decoderState.image1 = null;
                return true;
            } else {
                // not enough data available to read second image
                return false;
            }
        }
        return false;
    }

    private BufferedImage readImage(IoBuffer in) throws IOException {
        int length = in.getInt();
        byte[] bytes = new byte[length];
        in.get(bytes);
        ByteArrayInputStream bais = new ByteArrayInputStream(bytes);
        return ImageIO.read(bais);
    }
}
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;</p>
<ul>
<li>&#x6211;&#x4EEC;&#x5C06;&#x89E3;&#x7801;&#x8FC7;&#x7A0B;&#x7684;&#x72B6;&#x6001;&#x4FDD;&#x5B58;&#x4E3A;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x5C5E;&#x6027;&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E00;&#x72B6;&#x6001;&#x4FDD;&#x5B58;&#x5728;&#x89E3;&#x7801;&#x5668;&#x5BF9;&#x8C61;&#x81EA;&#x8EAB;&#x4E2D;&#xFF0C;&#x4F46;&#x8FD9;&#x4E48;&#x5E72;&#x6709;&#x4E00;&#x4E9B;&#x7F3A;&#x70B9;&#xFF1A;         <ul>
<li>&#x6BCF;&#x4E2A; IoSession &#x9700;&#x8981;&#x81EA;&#x5DF1;&#x7684;&#x89E3;&#x7801;&#x5668;&#x5B9E;&#x4F8B;</li>
<li>MINA &#x80FD;&#x591F;&#x786E;&#x4FDD;&#x4E0D;&#x4F1A;&#x6709;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x540C;&#x65F6;&#x4E3A;&#x540C;&#x4E00;&#x4E2A; IoSession &#x6267;&#x884C; decode() &#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x8FD9;&#x5E76;&#x4E0D;&#x80FD;&#x62C5;&#x4FDD;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x603B;&#x8FF0;&#x540C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;&#x5047;&#x8BBE;&#x7B2C;&#x4E00;&#x5757;&#x6570;&#x636E;&#x6709;&#x7EBF;&#x7A0B; 1 &#x5904;&#x7406;&#xFF0C;&#x7EBF;&#x7A0B; 1 &#x8BA4;&#x4E3A;&#x8FD8;&#x4E0D;&#x80FD;&#x89E3;&#x7801;&#xFF0C;&#x5F53;&#x4E0B;&#x4E00;&#x5757;&#x6570;&#x636E;&#x5230;&#x8FBE;&#x65F6;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x3002;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x53EF;&#x89C1;&#x6027;&#x95EE;&#x9898;&#xFF0C;&#x4F60;&#x5FC5;&#x987B;&#x5BF9;&#x8FD9;&#x4E00;&#x89E3;&#x7801;&#x72B6;&#x6001;&#x8FDB;&#x884C;&#x9002;&#x5F53;&#x52A0;&#x9501; (IoSession &#x7684;&#x5C5E;&#x6027;&#x4FDD;&#x5B58;&#x5728;&#x4E00;&#x4E2A; ConcurrentHashMap&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x4EEC;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x662F;&#x81EA;&#x52A8;&#x53EF;&#x89C1;&#x7684;)</li>
<li>&#x5728;&#x90AE;&#x4EF6;&#x5217;&#x8868;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8BA8;&#x8BBA;&#x5F97;&#x51FA;&#x4E86;&#x8FD9;&#x4E00;&#x7ED3;&#x8BBA;&#xFF1A;&#x5173;&#x4E8E;&#x662F;&#x628A;&#x72B6;&#x6001;&#x4FDD;&#x5B58;&#x5728; IoSession &#x8FD8;&#x662F;&#x89E3;&#x7801;&#x5668;&#x5B9E;&#x4F8B;&#x4E2D;&#x7684;&#x9009;&#x62E9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x6709;&#x8DA3;&#x7684;&#x95EE;&#x9898;&#x3002;&#x8981;&#x786E;&#x4FDD;&#x4E0D;&#x4F1A;&#x6709;&#x4E24;&#x4E2A;&#x4EE5;&#x4E0A;&#x7684;&#x7EBF;&#x7A0B;&#x4E3A;&#x540C;&#x4E00;&#x4E2A; IoSession &#x8FD0;&#x884C;&#x89E3;&#x7801;&#x65B9;&#x6CD5;&#xFF0C;MINA &#x9700;&#x8981;&#x505A;&#x67D0;&#x79CD;&#x5F62;&#x5F0F;&#x7684;&#x540C;&#x6B65; =&gt; &#x8FD9;&#x4E00;&#x540C;&#x6B65;&#x4E5F;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x4F60;&#x4E0D;&#x4F1A;&#x9047;&#x5230;&#x4E0A;&#x9762;&#x63CF;&#x8FF0;&#x7684;&#x53EF;&#x89C1;&#x6027;&#x95EE;&#x9898;&#x3002;(&#x611F;&#x8C22; Adam Fisk &#x6307;&#x51FA;&#x8FD9;&#x4E00;&#x70B9;) &#x53C2;&#x8003; <a href="http://www.nabble.com/Tutorial-on-ProtocolCodecFilter,-state-and-threads-t3965413.html" target="_blank">http://www.nabble.com/Tutorial-on-ProtocolCodecFilter,-state-and-threads-t3965413.html</a></li>
</ul>
</li>
<li>IoBuffer.prefixedDataAvailable() &#x5728;&#x4F60;&#x7684;&#x534F;&#x8BAE;&#x4E8B;&#x5B9C;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x524D;&#x7F00;&#x65F6;&#x5F88;&#x662F;&#x4FBF;&#x5229;&#xFF1B;&#x5B83;&#x652F;&#x6301; 1&#x3001;2 &#x6216; 4 &#x4E2A;&#x5B57;&#x8282;&#x7684;&#x524D;&#x7F00;</li>
<li>&#x5728;&#x4F60;&#x89E3;&#x7801;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x5019;&#x522B;&#x5FD8;&#x4E86;&#x590D;&#x4F4D;&#x89E3;&#x7801;&#x72B6;&#x6001; (&#x5C06;&#x8BE5;&#x4F1A;&#x8BDD;&#x5C5E;&#x6027;&#x5220;&#x9664;&#x662F;&#x89E3;&#x51B3;&#x8FD9;&#x79CD;&#x95EE;&#x9898;&#x7684;&#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;)</li>
</ul>
<p>&#x5982;&#x679C;&#x54CD;&#x5E94;&#x53EA;&#x6709;&#x5355;&#x4E00;&#x7684;&#x4E00;&#x4E2A;&#x56FE;&#x7247;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x65E0;&#x9700;&#x4FDD;&#x5B58;&#x89E3;&#x7801;&#x72B6;&#x6001;&#x4E86;&#xFF1A;</p>
<pre><code>protected boolean doDecode(IoSession session, IoBuffer in, ProtocolDecoderOutput out) throws Exception {
    if (in.prefixedDataAvailable(4)) {
        int length = in.getInt();
        byte[] bytes = new byte[length];
        in.get(bytes);
        ByteArrayInputStream bais = new ByteArrayInputStream(bytes);
        BufferedImage image = ImageIO.read(bais);
        out.write(image);
        return true;
    } else {
        return false;
    }
}
</code></pre><p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x628A;&#x5B83;&#x4EEC;&#x90FD;&#x7EC4;&#x5408;&#x5728;&#x4E00;&#x8D77;&#xFF1A;</p>
<pre><code>public class ImageCodecFactory implements ProtocolCodecFactory {
    private ProtocolEncoder encoder;
    private ProtocolDecoder decoder;

    public ImageCodecFactory(boolean client) {
        if (client) {
            encoder = new ImageRequestEncoder();
            decoder = new ImageResponseDecoder();
        } else {
            encoder = new ImageResponseEncoder();
            decoder = new ImageRequestDecoder();
        }
    }

    public ProtocolEncoder getEncoder(IoSession ioSession) throws Exception {
        return encoder;
    }

    public ProtocolDecoder getDecoder(IoSession ioSession) throws Exception {
        return decoder;
    }
}
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;</p>
<ul>
<li>&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;&#x65B0;&#x4F1A;&#x8BDD;&#xFF0C;MINA &#x5C06;&#x4F1A;&#x8BF7;&#x6C42; ImageCodecFactory &#x4EE5;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x7F16;&#x7801;&#x5668;&#x6216;&#x8005;&#x4E00;&#x4E2A;&#x89E3;&#x7801;&#x5668;</li>
<li>&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x7F16;&#x7801;&#x5668;&#x548C;&#x89E3;&#x7801;&#x5668;&#x6CA1;&#x6709;&#x4FDD;&#x5B58;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x6B64;&#x8BA9;&#x6240;&#x6709;&#x4F1A;&#x8BDD;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x5355;&#x4E00;&#x5B9E;&#x4F8B;&#x662F;&#x5B89;&#x5168;&#x7684;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x662F;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5BF9; ProtocolCodecFactory &#x7684;&#x4F7F;&#x7528;&#xFF1A;</p>
<pre><code>public class ImageServer {
    public static final int PORT = 33789;

    public static void main(String[] args) throws IOException {
        ImageServerIoHandler handler = new ImageServerIoHandler();
        NioSocketAcceptor acceptor = new NioSocketAcceptor();
        acceptor.getFilterChain().addLast(&quot;protocol&quot;, new ProtocolCodecFilter(new ImageCodecFactory(false)));
        acceptor.setLocalAddress(new InetSocketAddress(PORT));
        acceptor.setHandler(handler);
        acceptor.bind();
        System.out.println(&quot;server is listenig at port &quot; + PORT);
    }
}
</code></pre><p>&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4F7F;&#x7528;&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF1A;</p>
<pre><code>public class ImageClient extends IoHandlerAdapter {
    public static final int CONNECT_TIMEOUT = 3000;

    private String host;
    private int port;
    private SocketConnector connector;
    private IoSession session;
    private ImageListener imageListener;

    public ImageClient(String host, int port, ImageListener imageListener) {
        this.host = host;
        this.port = port;
        this.imageListener = imageListener;
        connector = new NioSocketConnector();
        connector.getFilterChain().addLast(&quot;codec&quot;, new ProtocolCodecFilter(new ImageCodecFactory(true)));
        connector.setHandler(this);
    }

    public void messageReceived(IoSession session, Object message) throws Exception {
        ImageResponse response = (ImageResponse) message;
        imageListener.onImages(response.getImage1(), response.getImage2());
    }
    ...
</code></pre><p>&#x5B8C;&#x6574;&#x6027;&#x8003;&#x8651;&#xFF0C;&#x73B0;&#x5728;&#x9644;&#x52A0;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684; IoHandler &#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code>public class ImageServerIoHandler extends IoHandlerAdapter {

    private final static String characters = &quot;mina rocks abcdefghijklmnopqrstuvwxyz0123456789&quot;;

    public static final String INDEX_KEY = ImageServerIoHandler.class.getName() + &quot;.INDEX&quot;;

    private Logger logger = LoggerFactory.getLogger(this.getClass());

    public void sessionOpened(IoSession session) throws Exception {
        session.setAttribute(INDEX_KEY, 0);
    }

    public void exceptionCaught(IoSession session, Throwable cause) throws Exception {
        IoSessionLogger sessionLogger = IoSessionLogger.getLogger(session, logger);
        sessionLogger.warn(cause.getMessage(), cause);
    }

    public void messageReceived(IoSession session, Object message) throws Exception {
        ImageRequest request = (ImageRequest) message;
        String text1 = generateString(session, request.getNumberOfCharacters());
        String text2 = generateString(session, request.getNumberOfCharacters());
        BufferedImage image1 = createImage(request, text1);
        BufferedImage image2 = createImage(request, text2);
        ImageResponse response = new ImageResponse(image1, image2);
        session.write(response);
    }

    private BufferedImage createImage(ImageRequest request, String text) {
        BufferedImage image = new BufferedImage(request.getWidth(), request.getHeight(), BufferedImage.TYPE_BYTE_INDEXED);
        Graphics graphics = image.createGraphics();
        graphics.setColor(Color.YELLOW);
        graphics.fillRect(0, 0, image.getWidth(), image.getHeight());
        Font serif = new Font(&quot;serif&quot;, Font.PLAIN, 30);
        graphics.setFont(serif);
        graphics.setColor(Color.BLUE);
        graphics.drawString(text, 10, 50);
        return image;
    }

    private String generateString(IoSession session, int length) {
        Integer index = (Integer) session.getAttribute(INDEX_KEY);
        StringBuffer buffer = new StringBuffer(length);

        while (buffer.length() &lt; length) {
            buffer.append(characters.charAt(index));
            index++;
            if (index &gt;= characters.length()) {
                index = 0;
            }
        }
        session.setAttribute(INDEX_KEY, index);
        return buffer.toString();
    }
}
</code></pre><p><img src="codec-filter.jpeg" alt=""></p>
<h2 id="&#x7ED3;&#x8BBA;">&#x7ED3;&#x8BBA;</h2>
<p>&#x5173;&#x4E8E;&#x7F16;&#x7801;&#x548C;&#x89E3;&#x7801;&#x4E0D;&#x4EC5;&#x4E8E;&#x6B64;&#x3002;&#x4F46;&#x662F;&#x6211;&#x5E0C;&#x671B;&#x672C;&#x6587;&#x8DB3;&#x4EE5;&#x8BA9;&#x4F60;&#x5F00;&#x59CB;&#x4E86;&#x3002;&#x4E0D;&#x4E45;&#x7684;&#x5C06;&#x6765;&#x6211;&#x4F1A;&#x5C1D;&#x8BD5;&#x7740;&#x6DFB;&#x52A0;&#x5173;&#x4E8E; DemuxingProtocolCodecFactory &#x7684;&#x4E00;&#x4E9B;&#x4ECB;&#x7ECD;&#x3002;&#x5C4A;&#x65F6;&#x6211;&#x4EEC;&#x4E5F;&#x5C06;&#x770B;&#x4E00;&#x4E0B;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B9A;&#x754C;&#x7B26;&#x53D6;&#x4EE3;&#x957F;&#x5EA6;&#x524D;&#x7F00;&#x7684;&#x505A;&#x6CD5;</p>
<p><em>&#x8BD1;&#x8005;&#x6CE8;&#xFF1A;&#x7FFB;&#x8BD1;&#x7248;&#x672C;&#x7684;&#x9879;&#x76EE;&#x6E90;&#x7801;&#x89C1; <a href="https://github.com/waylau/apache-mina-2-user-guide-demos" target="_blank">https://github.com/waylau/apache-mina-2-user-guide-demos</a> &#x4E2D;&#x7684;<code>com.waylau.mina.demo.imagine</code>&#x5305;&#x4E0B;</em></p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Part II - MINA Core/Chapter 8 - IoBuffer.html" class="navigation navigation-prev " aria-label="Previous page: Chapter 8 - IoBuffer"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Part II - MINA Core/Chapter 10 - Executor Filter.html" class="navigation navigation-next " aria-label="Next page: Chapter 10 - Executor 过滤器"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
